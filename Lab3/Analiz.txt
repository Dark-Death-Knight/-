import html
import telebot
from telebot import types
import requests
import json
import datetime

bot = telebot.TeleBot('8038191080:AAEH1x4Jh1JQPKVjztrhGtOfw1btElAxlKA')

# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_data = {}

@bot.message_handler(commands=['start'])
def start(message):
    user_id = message.from_user.id
    user_data[user_id] = {
        'first_name': message.from_user.first_name,
        'last_name': message.from_user.last_name,
        'join_date': datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
        'message_count': 0
    }
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    item1 = types.KeyboardButton('üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è')
    item2 = types.KeyboardButton('üÜò –ü–æ–º–æ—â—å')
    item3 = types.KeyboardButton('üåê –°–∞–π—Ç')
    markup.add(item1, item2, item3)
    
    welcome_text = f"""
    üëã –ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!

–Ø –º–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –±–æ—Ç —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏:

üìù /text - –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞
üìä /stats - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
üïê /time - –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
üå§ /weather - –ü–æ–≥–æ–¥–∞
üé≤ /random - –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ

–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ!
    """
    
    bot.send_message(message.chat.id, welcome_text, reply_markup=markup, parse_mode='HTML')

@bot.message_handler(commands=['help'])
def help_command(message):
    help_text = """
<b>üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>

<code>/start</code> - –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
<code>/help</code> - –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º
<code>/text</code> - HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
<code>/stats</code> - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
<code>/time</code> - –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
<code>/weather</code> - –ü–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ
<code>/random</code> - –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ
<code>/inline</code> - Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞

<em>–¢–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ - —è –µ–≥–æ –æ–±—Ä–∞–±–æ—Ç–∞—é!</em>
    """
    bot.send_message(message.chat.id, help_text, parse_mode='HTML')

@bot.message_handler(commands=['text'])
def text_formatting(message):
    formatting_examples = """
<b>üñã –ü—Ä–∏–º–µ—Ä—ã HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:</b>

<b>–ñ–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç</b> - <code>&lt;b&gt;—Ç–µ–∫—Å—Ç&lt;/b&gt;</code>
<em>–ö—É—Ä—Å–∏–≤</em> - <code>&lt;em&gt;—Ç–µ–∫—Å—Ç&lt;/em&gt;</code>
<u>–ü–æ–¥—á–µ—Ä–∫–Ω—É—Ç—ã–π</u> - <code>&lt;u&gt;—Ç–µ–∫—Å—Ç&lt;/u&gt;</code>
<s>–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π</s> - <code>&lt;s&gt;—Ç–µ–∫—Å—Ç&lt;/s&gt;</code>
<code>–ú–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π</code> - <code>&lt;code&gt;—Ç–µ–∫—Å—Ç&lt;/code&gt;</code>
<a href="https://telegram.org">–°—Å—ã–ª–∫–∞</a> - <code>&lt;a href="URL"&gt;—Ç–µ–∫—Å—Ç&lt;/a&gt;</code>
    """
    bot.send_message(message.chat.id, formatting_examples, parse_mode='HTML')

@bot.message_handler(commands=['stats'])
def stats(message):
    user_id = message.from_user.id
    if user_id in user_data:
        user_info = user_data[user_id]
        stats_text = f"""
<b>üìä –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:</b>

üë§ –ò–º—è: {user_info['first_name']}
üìÖ –î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user_info['join_date']}
üì® –°–æ–æ–±—â–µ–Ω–∏–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {user_info['message_count']}
üÜî –í–∞—à ID: <code>{user_id}</code>
        """
    else:
        stats_text = "‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start"
    
    bot.send_message(message.chat.id, stats_text, parse_mode='HTML')

@bot.message_handler(commands=['time'])
def current_time(message):
    current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    time_text = f"""
<b>üïê –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è:</b>

üìÖ –î–∞—Ç–∞: <code>{datetime.datetime.now().strftime('%d.%m.%Y')}</code>
‚è∞ –í—Ä–µ–º—è: <code>{datetime.datetime.now().strftime('%H:%M:%S')}</code>
üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å: –ú–°–ö (UTC+3)
    """
    bot.send_message(message.chat.id, time_text, parse_mode='HTML')

@bot.message_handler(commands=['weather'])
def weather(message):
    try:
        # –ü—Ä–∏–º–µ—Ä API –∑–∞–ø—Ä–æ—Å–∞ (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π API –∫–ª—é—á)
        # response = requests.get(f"http://api.openweathermap.org/data/2.5/weather?q=Moscow&appid=YOUR_API_KEY")
        # weather_data = response.json()
        
        # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
        weather_text = """
<b>üå§ –ü–æ–≥–æ–¥–∞ –≤ –ú–æ—Å–∫–≤–µ:</b>

üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: +5¬∞C
üí® –í–µ—Ç–µ—Ä: 3 –º/—Å
üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: 75%
‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ—Å—Ç—å: –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è
üìã –û–ø–∏—Å–∞–Ω–∏–µ: –õ–µ–≥–∫–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å

<em>–û–±–Ω–æ–≤–ª–µ–Ω–æ: —Å–µ–π—á–∞—Å</em>
        """
        bot.send_message(message.chat.id, weather_text, parse_mode='HTML')
    except Exception as e:
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–≥–æ–¥—ã")

@bot.message_handler(commands=['random'])
def random_number(message):
    import random
    number = random.randint(1, 100)
    random_text = f"""
<b>üé≤ –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ:</b>

–í–∞—à–µ —á–∏—Å–ª–æ: <code>{number}</code>
–î–∏–∞–ø–∞–∑–æ–Ω: 1-100

<em>–•–æ—Ç–∏—Ç–µ –µ—â–µ? –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É —Å–Ω–æ–≤–∞!</em>
    """
    bot.send_message(message.chat.id, random_text, parse_mode='HTML')

@bot.message_handler(commands=['inline'])
def inline_keyboard(message):
    markup = types.InlineKeyboardMarkup()
    btn1 = types.InlineKeyboardButton('üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞', callback_data='stats')
    btn2 = types.InlineKeyboardButton('üïê –í—Ä–µ–º—è', callback_data='time')
    btn3 = types.InlineKeyboardButton('üé≤ –°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ', callback_data='random')
    btn4 = types.InlineKeyboardButton('üåê –°–∞–π—Ç', url='https://telegram.org')
    markup.add(btn1, btn2)
    markup.add(btn3, btn4)
    
    bot.send_message(message.chat.id, "üîò –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: True)
def callback_handler(call):
    if call.data == 'stats':
        user_id = call.from_user.id
        if user_id in user_data:
            count = user_data[user_id]['message_count']
            bot.answer_callback_query(call.id, f"–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ {count} —Å–æ–æ–±—â–µ–Ω–∏–π")
        else:
            bot.answer_callback_query(call.id, "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    elif call.data == 'time':
        current_time = datetime.datetime.now().strftime("%H:%M:%S")
        bot.answer_callback_query(call.id, f"–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è: {current_time}")
    
    elif call.data == 'random':
        import random
        number = random.randint(1, 100)
        bot.answer_callback_query(call.id, f"–°–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ: {number}")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
@bot.message_handler(content_types=['text'])
def handle_text(message):
    user_id = message.from_user.id
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
    if user_id in user_data:
        user_data[user_id]['message_count'] += 1
    else:
        user_data[user_id] = {
            'first_name': message.from_user.first_name,
            'last_name': message.from_user.last_name,
            'join_date': datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
            'message_count': 1
        }
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–∞ –∏–∑ –∫–Ω–æ–ø–æ–∫
    if message.text == 'üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è':
        info_text = """
<b>‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:</b>

–≠—Ç–æ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π Telegram –±–æ—Ç
—Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏ –∫–æ–º–∞–Ω–¥–∞–º–∏.

–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω –Ω–∞ Python —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
–±–∏–±–ª–∏–æ—Ç–µ–∫–∏ pyTelegramBotAPI.

üîß –§—É–Ω–∫—Ü–∏–∏:
‚Ä¢ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ Inline –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
‚Ä¢ –û–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤
        """
        bot.send_message(message.chat.id, info_text, parse_mode='HTML')
    
    elif message.text == 'üÜò –ü–æ–º–æ—â—å':
        help_command(message)
    
    elif message.text == 'üåê –°–∞–π—Ç':
        markup = types.InlineKeyboardMarkup()
        btn = types.InlineKeyboardButton('–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å–∞–π—Ç Telegram', url='https://telegram.org')
        markup.add(btn)
        bot.send_message(message.chat.id, "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞:", reply_markup=markup)
    
    else:
        # –≠—Ö–æ-–æ—Ç–≤–µ—Ç —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π HTML
        response = f"""
<b>üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:</b>

<code>{html.escape(message.text)}</code>

üìä –î–ª–∏–Ω–∞: {len(message.text)} —Å–∏–º–≤–æ–ª–æ–≤
üë§ –û—Ç: {message.from_user.first_name}
        """
        bot.send_message(message.chat.id, response, parse_mode='HTML')

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
@bot.message_handler(content_types=['photo', 'document', 'sticker'])
def handle_media(message):
    bot.send_message(message.chat.id, f"üìé –ü–æ–ª—É—á–µ–Ω –º–µ–¥–∏–∞-—Ñ–∞–π–ª! –¢–∏–ø: {message.content_type}")

# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    try:
        bot.polling(none_stop=True)
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")
